#!/usr/bin/env node

/**
 * @file warhorse
 * @description The Warhorse command-line interface (CLI).
 * @author Kyle Alexis Sargeant <kasargeant@gmail.com> {@link https://github.com/kasargeant https://github.com/kasargeant}.
 * @copyright Kyle Alexis Sargeant 2017
 * @license See LICENSE file included in this distribution.
 */

"use strict";

// Imports
const path = require("path");

let argv = require("minimist")(process.argv.slice(2), {
    string: "task",
    alias: {h: "help", v: "version"},
    default: {task: "build"},
    "--": true
});

let workingDirectory = process.cwd() + "/";
let moduleDirectory = path.join(__dirname, "..") + "/";

const run = require("../src/index");

const commands = ["build", "clean", "create", "distribute", "document", "init", "lint", "pack", "precompile", "test"]; //FIXME - replace with Object.keys(warhorse.tasks);

const help = `
  ============================================================================
  WARHORSE HELP
  
	Usage
	  $ warhorse <flags> <command> <options>

	Commands
	  build,         Builds the project in the current directory.
	  create,        Initialises and creates a new project interactively in a named sub-directory.
	  distribute,    Makes a final distribution build of the project in the ./dist directory.
	  document,      Documents the project in the current directory.
	  lint,          Runs linters across the project - checking both code style and quality.
	  precompile,    Precompiles and minimises all style and template assets.
	  test           Test the project code - runs both unit and integration tests.

	Flags
	  --config,  -c  Use a specific config file.
	  --help,    -h  Shows this information.
	  --project, -p  Use a specific project convention.
	  --version, -v  Shows Warhorse CLI version.

	Examples
	  $ warhorse create module
	     
	  $ warhorse distribute 
	     ðŸŒˆ ...CRUSHING YOUR ENEMIES!!! ðŸŒˆ

  ============================================================================

`;

function showHelp() {
    console.log();
    console.log(`Warhorse CLI directory: ${moduleDirectory}`);
    console.log(`Working directory: ${workingDirectory}`);
    console.log(help);
}

// Respond to user input
if(argv.help === true) {
    showHelp();
} else if(argv.version === true) {
    let warhorsePackage = require(moduleDirectory + "/" + "package.json");
    console.log(`Warhorse version: ${warhorsePackage.version}`);
} else if(argv._.length > 0) {

    // Determine command
    if(commands.includes(argv._[0])) {
        run(moduleDirectory, workingDirectory, argv._); // Passes command and rest args
    } else {
        console.error(`Error: Unrecognised command '${argv._[0]}'.`);
        showHelp();
    }
} else {
    console.error(`Error: Missing any command.`);
    showHelp();
}
